<div class="edit-dialog">
  <div class="edit-post-wrapper">
    <div class="edit-post-container">
      <!-- Header -->
      <header class="post-header">
        <h1 class="page-title">Edit Story</h1>
        <p class="page-subtitle">Update your knowledge and experiences</p>
      </header>

      <!-- Form -->
      <form [formGroup]="postForm" (ngSubmit)="updatePost()" class="post-form">
        <!-- Title Field -->
        <div class="form-section">
          <mat-form-field appearance="outline" class="title-field">
            <mat-label>Title</mat-label>
            <input
              matInput
              formControlName="title"
              placeholder="Write a captivating title..."
              class="title-input"
            />
            <mat-error *ngIf="postForm.get('title')?.hasError('required')">
              Title is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Body Field -->
        <div class="form-section">
          <mat-form-field appearance="outline" class="body-field">
            <mat-label>Update your story...</mat-label>
            <textarea
              matInput
              rows="12"
              formControlName="body"
              placeholder="Share your thoughts..."
              class="body-textarea"
            ></textarea>
            <mat-error *ngIf="postForm.get('body')?.hasError('required')">
              Story content is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Categories -->
        <div class="form-section">
          <mat-form-field appearance="outline" class="category-field">
            <mat-label>Topics (at least 1)</mat-label>
            <mat-select formControlName="categoryIds" multiple>
              <mat-option *ngFor="let cat of categories" [value]="cat.id">
                {{ cat.name }}
              </mat-option>
            </mat-select>
            <mat-hint>Help readers discover your story</mat-hint>
            <mat-error *ngIf="postForm.get('categoryIds')?.hasError('required')">
              At least one topic is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Media Blocks -->
        <div class="media-section" *ngIf="visibleMediaBlocks.length > 0">
          <div class="section-title">
            <h3>Media Attachments</h3>

            <button
              type="button"
              mat-stroked-button
              (click)="addMediaBlock()"
              *ngIf="visibleMediaBlocks.length < 10"
              class="add-media-btn"
            >
              <mat-icon>add_photo_alternate</mat-icon>
              Add More
            </button>
          </div>

          <div class="media-list">
            <ng-container
              *ngFor="let block of visibleMediaBlocks; let i = index; trackBy: trackByTempId"
            >
              <div class="media-block" [attr.data-id]="block.tempId">
                <!-- Header -->
                <div class="media-block-header">
                  <div class="media-position">
                    <span class="position-label">Media {{ i + 1 }}</span>
                  </div>

                  <button
                    type="button"
                    mat-icon-button
                    color="warn"
                    (click)="removeMediaBlockByBlock(block)"
                    matTooltip="Remove media"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>

                <!-- File Input (order matches visible list) -->
                <input
                  #fileInput
                  type="file"
                  hidden
                  accept="image/*,video/*"
                  (change)="onFileSelected($event, block)"
                />

                <!-- Preview/Content -->
                <div class="media-content">
                  <!-- Upload placeholder -->
                  <div
                    *ngIf="!hasPreview(block)"
                    class="upload-area"
                    (click)="triggerFileInput(i)"
                  >
                    <mat-icon class="upload-icon">cloud_upload</mat-icon>
                    <p class="upload-text">Click to upload image or video</p>
                    <span class="upload-hint">Max size: 20MB</span>
                  </div>

                  <!-- Preview -->
                  <div *ngIf="hasPreview(block)" class="media-preview">
                    <div class="preview-wrapper">
                      <img
                        *ngIf="!block.file && block.existingUrl && isImageUrl(block.existingUrl)"
                        [src]="getPreview(block)"
                        alt="Preview"
                        class="preview-image"
                      />
                      <video
                        *ngIf="!block.file && block.existingUrl && isVideoUrl(block.existingUrl)"
                        [src]="getPreview(block)"
                        controls
                        class="preview-video"
                      ></video>

                      <img
                        *ngIf="block.file && isImage(block.file)"
                        [src]="getPreview(block)"
                        alt="Preview"
                        class="preview-image"
                      />
                      <video
                        *ngIf="block.file && isVideo(block.file)"
                        [src]="getPreview(block)"
                        controls
                        class="preview-video"
                      ></video>
                    </div>

                    <button
                      type="button"
                      mat-stroked-button
                      (click)="triggerFileInput(i)"
                      class="change-media-btn"
                    >
                      <mat-icon>edit</mat-icon>
                      Change Media
                    </button>
                  </div>
                </div>

                <!-- Caption -->
                <mat-form-field appearance="outline" class="caption-field">
                  <mat-label>Description (required)</mat-label>
                  <textarea
                    matInput
                    [(ngModel)]="block.description"
                    [ngModelOptions]="{ standalone: true }"
                    maxlength="500"
                    rows="2"
                    placeholder="Describe this media..."
                  ></textarea>
                  <mat-hint align="end">{{ (block.description || '').length }}/500</mat-hint>
                </mat-form-field>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Add First Media -->
        <div class="add-first-media" *ngIf="visibleMediaBlocks.length === 0">
          <button
            type="button"
            mat-stroked-button
            (click)="addMediaBlock()"
            class="add-first-btn"
          >
            <mat-icon>add_photo_alternate</mat-icon>
            Add images or videos to your story
          </button>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button type="button" mat-button (click)="cancel()" class="cancel-btn">
            Cancel
          </button>

          <button
            type="submit"
            mat-flat-button
            color="primary"
            [disabled]="isSubmitting || postForm.invalid || hasInvalidMedia"
            class="publish-btn"
          >
            <span *ngIf="!isSubmitting">Update Story</span>
            <span *ngIf="isSubmitting" class="submitting">
              <mat-icon class="spin-icon">autorenew</mat-icon>
              Updating...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

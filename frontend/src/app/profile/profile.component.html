<mat-card class="profile-card" *ngIf="user; else errTpl">
  <div class="profile-header">
    <!-- Circular avatar with fixed size -->
    <div class="avatar-container">
      <img *ngIf="user.avatarUrl; else defaultAvatar" [src]="user.avatarUrl" alt="Avatar" class="profile-avatar" />
      <ng-template #defaultAvatar>
        <div class="avatar-placeholder">
          <mat-icon class="placeholder-icon">account_circle</mat-icon>
        </div>
      </ng-template>
    </div>

    <div class="profile-info">
      <div class="name-row">
        <h2 class="user-name">{{ user.name }}</h2>
        <div class="username">@{{ user.username }}</div>
      </div>
      <div class="profile-meta">
        <span *ngIf="user.age !== null" class="meta-item">Age: {{ user.age }}</span>
        <span *ngIf="user.email" class="meta-item email">{{ user.email }}</span>
        <span class="meta-item clickable" (click)="showFollowersList()">
          <strong>{{ user.subscribersCount || 0 }}</strong>
          <span>{{ user.subscribersCount === 1 ? 'follower' : 'followers' }}</span>
        </span>

        <span class="meta-item clickable" (click)="showFollowingList()">
          <strong>{{ user.subscriptionsCount || 0 }}</strong>
          <span>{{ user.subscriptionsCount === 1 ? 'following' : 'following' }}</span>
        </span>
      </div>

      <div *ngIf="user.bio" class="bio">{{ user.bio }}</div>
    </div>
  </div>

  <div *ngIf="user && currentUserId && user.id !== currentUserId" class="follow-btn-container">
    <button mat-button color="primary" class="follow-btn" [disabled]="currentUserId === user?.id"
      (click)="toggleFollow()">
      {{ user?.isSubscribed ? 'Unfollow' : 'Follow' }}
    </button>




  </div>

  <button *ngIf="currentUserId && user?.id === currentUserId" mat-stroked-button class="edit-profile-btn"
    (click)="editProfile()">
    Edit Profile
  </button>
</mat-card>

<!-- Followers/Following Modal Overlay -->
<div class="modal-overlay" *ngIf="showFollowers || showFollowing" (click)="closeList()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ showFollowers ? 'Followers' : 'Following' }}</h3>
      <button mat-icon-button class="close-btn" (click)="closeList()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <div class="modal-body">
      <mat-spinner *ngIf="loadingFollowers || loadingFollowing"></mat-spinner>
      
      <div *ngIf="!loadingFollowers && !loadingFollowing" class="users-list">
        <div *ngIf="showFollowers && followers.length === 0" class="empty-state">
          No followers yet.
        </div>
        <div *ngIf="showFollowing && following.length === 0" class="empty-state">
          Not following anyone yet.
        </div>
        
        <div *ngFor="let u of (showFollowers ? followers : following)" 
             class="user-item" 
             (click)="goToUserProfile(u.username)">
          <div class="user-avatar">
            <img *ngIf="u.avatarUrl" [src]="u.avatarUrl" alt="Avatar" />
            <mat-icon *ngIf="!u.avatarUrl">account_circle</mat-icon>
          </div>
          <div class="user-info">
            <div class="user-name">{{ u.name }}</div>
            <div class="user-username">@{{ u.username }}</div>
          </div>
          <mat-icon class="arrow-icon">chevron_right</mat-icon>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Error template -->
<ng-template #errTpl>
  <mat-card class="profile-card error">
    <p *ngIf="error">{{ error }}</p>
    <mat-spinner *ngIf="loading"></mat-spinner>
  </mat-card>
</ng-template>

<!-- MENU OUTSIDE CARD -->
<div class="profile-menu" *ngIf="user">
  <button mat-button [class.active]="selectedTab === 'my'" (click)="onTabChange('my')">
    My posts
  </button>
  <button mat-button [class.active]="selectedTab === 'saved'" (click)="onTabChange('saved')">
    Saved
  </button>
  <button mat-button [class.active]="selectedTab === 'liked'" (click)="onTabChange('liked')">
    Liked
  </button>
</div>

<!-- POSTS GRID: each post is its own card -->
<div class="posts-section" *ngIf="user">
  <mat-spinner *ngIf="loadingPosts"></mat-spinner>
  <div class="posts-grid" *ngIf="!loadingPosts && posts.length">
    <mat-card class="post-card" *ngFor="let post of posts" (click)="goToPostDetail(post)">
      <mat-card-header>
        <mat-card-title>{{ post.title }}</mat-card-title>
        <mat-card-subtitle>
          {{ post.createdAt | date: 'short' }} ·
          {{ post.likes }} likes · {{ post.comments }} comments
        </mat-card-subtitle>
      </mat-card-header>

      <!-- Media preview -->
      <ng-container *ngIf="post.mediaUrl">
        <div class="media-preview-container">
          <img *ngIf="post.mediaType === 'image'" [src]="post.mediaUrl" alt="Post image" class="post-media-preview" />
          <video *ngIf="post.mediaType === 'video'" [src]="post.mediaUrl" class="post-media-preview" muted
            preload="metadata"></video>
        </div>
      </ng-container>


      <mat-card-content>
        <p>{{ post.excerpt }}</p>
      </mat-card-content>
    </mat-card>
  </div>


  <p *ngIf="!loadingPosts && !posts.length">
    No posts to show.
  </p>
</div>
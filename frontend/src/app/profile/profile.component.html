<!-- profile.component.html -->

<!-- Profile card only for user info -->
<!-- Profile card only for user info -->
<mat-card class="profile-card" *ngIf="user; else errTpl">
  <div class="profile-header">
    <!-- Circular avatar with fixed size -->
    <div class="avatar-container">
      <img *ngIf="user.avatarUrl; else defaultAvatar" [src]="user.avatarUrl" alt="Avatar" class="profile-avatar" />
      <ng-template #defaultAvatar>
        <div class="avatar-placeholder">
          <mat-icon class="placeholder-icon">account_circle</mat-icon>
        </div>
      </ng-template>
    </div>

    <div class="profile-info">
      <div class="name-row">
        <h2 class="user-name">{{ user.name }}</h2>
        <div class="username">@{{ user.username }}</div>
      </div>
       <div class="profile-meta">
        <span *ngIf="user.age !== null" class="meta-item">Age: {{ user.age }}</span>
        <span *ngIf="user.email" class="meta-item email">{{ user.email }}</span>
        <span class="meta-item">Following: {{ user.subscriptionsCount || 0 }}</span>
        <span class="meta-item">Followers: {{ user.subscribersCount || 0 }}</span>
      </div>
      
      <div *ngIf="user.bio" class="bio">{{ user.bio }}</div>
    </div>
  </div>
  
 <div *ngIf="user && currentUserId && user.id !== currentUserId" class="follow-btn-container">
    <button mat-flat-button color="primary" (click)="toggleFollow()" class="follow-btn">
      {{ user?.isSubscribed ? 'Unfollow' : 'Follow' }}
    </button>
  </div>

  <button *ngIf="currentUserId && user?.id === currentUserId" 
          mat-stroked-button class="edit-profile-btn" 
          (click)="editProfile()">
    Edit Profile
  </button>
</mat-card>


<!-- Error template -->
<ng-template #errTpl>
  <mat-card class="profile-card error">
    <p *ngIf="error">{{ error }}</p>
    <mat-spinner *ngIf="loading"></mat-spinner>
  </mat-card>
</ng-template>

<!-- MENU OUTSIDE CARD -->
<div class="profile-menu" *ngIf="user">
  <button mat-button [class.active]="selectedTab === 'my'" (click)="onTabChange('my')">
    My posts
  </button>
  <button mat-button [class.active]="selectedTab === 'saved'" (click)="onTabChange('saved')">
    Saved
  </button>
  <button mat-button [class.active]="selectedTab === 'liked'" (click)="onTabChange('liked')">
    Liked
  </button>
</div>

<!-- POSTS GRID: each post is its own card -->
<div class="posts-section" *ngIf="user">
  <mat-spinner *ngIf="loadingPosts"></mat-spinner>
  <div class="posts-grid" *ngIf="!loadingPosts && posts.length">
    <mat-card class="post-card" *ngFor="let post of posts" (click)="goToPostDetail(post)">
      <mat-card-header>
        <mat-card-title>{{ post.title }}</mat-card-title>
        <mat-card-subtitle>
          {{ post.createdAt | date: 'short' }} ·
          {{ post.likes }} likes · {{ post.comments }} comments
        </mat-card-subtitle>
      </mat-card-header>

      <!-- Media preview -->
      <ng-container *ngIf="post.mediaUrl">
        <div class="media-preview-container">
          <img *ngIf="post.mediaType === 'image'" [src]="post.mediaUrl" alt="Post image" class="post-media-preview" />
          <video *ngIf="post.mediaType === 'video'" [src]="post.mediaUrl" class="post-media-preview" muted
            preload="metadata"></video>
        </div>
      </ng-container>


      <mat-card-content>
        <p>{{ post.excerpt }}</p>
      </mat-card-content>
    </mat-card>
  </div>


  <p *ngIf="!loadingPosts && !posts.length">
    No posts to show.
  </p>
</div>
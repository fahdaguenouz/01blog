<!-- profile.component.html -->
<div class="profile-wrapper">
  <!-- Loading/Error States -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="48" color="primary"></mat-spinner>
  </div>

  <!-- Error State -->
  <div *ngIf="!loading && error" class="error-container">
    <mat-icon class="error-icon">error_outline</mat-icon>

    <h3>{{ error }}</h3>
    <p>The profile you’re looking for doesn’t exist or was removed.</p>

    <button mat-flat-button color="primary" routerLink="/feed" class="back-btn">
      Back to feed
    </button>

  </div>


  <!-- Profile Content -->
  <div *ngIf="!loading && !error && user" class="profile-container">

    <!-- Profile Header -->
    <div class="profile-header">
      <div class="avatar-container">
        <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" alt="Avatar" class="profile-avatar" />
        <div *ngIf="!user.avatarUrl" class="avatar-placeholder">
          <mat-icon>account_circle</mat-icon>
        </div>
      </div>

      <div class="profile-info">
        <div class="name-row">
          <h1 class="user-name">{{ user.name }}</h1>
          <div class="username">@{{ user.username }}</div>
        </div>

        <div class="profile-meta">
          <span *ngIf="user.age !== null" class="meta-item">Age: {{ user.age }}</span>
          <span *ngIf="user.email" class="meta-item email">{{ user.email }}</span>
          <span class="meta-item clickable" (click)="showFollowersList()">
            <strong>{{ user.subscribersCount || 0 }}</strong>
            <span>{{ user.subscribersCount === 1 ? 'follower' : 'followers' }}</span>
          </span>
          <span class="meta-item clickable" (click)="showFollowingList()">
            <strong>{{ user.subscriptionsCount || 0 }}</strong>
            <span>{{ user.subscriptionsCount === 1 ? 'following' : 'followings' }}</span>
          </span>
        </div>

        <div *ngIf="user.bio" class="bio">{{ user.bio }}</div>
      </div>
    </div>

    <!-- Follow/Edit Buttons -->
    <div class="follow-btn-container">
      <!-- Follow button (other user) -->
      <button *ngIf="user && currentUserId && user.id !== currentUserId" mat-flat-button color="primary"
        class="follow-btn" (click)="toggleFollow()" [class.unfollow]="user.isSubscribed">
        {{ user.isSubscribed ? 'Unfollow' : 'Follow' }}
      </button>

      <!-- Edit button (my profile) -->
      <button *ngIf="currentUserId && user && user.id === currentUserId" mat-flat-button color="primary"
        class="follow-btn edit-btn" (click)="editProfile()">
        Edit Profile
      </button>
    </div>

    <!-- Tab Navigation -->
    <div class="profile-menu">
      <button mat-button [class.active]="selectedTab === 'my'" (click)="onTabChange('my')">
        {{ isMyProfile ? 'My posts' : 'Posts' }}
      </button>

      <button mat-button [class.active]="selectedTab === 'saved'" (click)="onTabChange('saved')">
        Saved
      </button>
      <button mat-button [class.active]="selectedTab === 'liked'" (click)="onTabChange('liked')">
        Liked
      </button>
    </div>

    <!-- Posts Section -->
    <div class="posts-container">
      <mat-spinner *ngIf="loadingPosts"></mat-spinner>

      <div *ngIf="!loadingPosts && posts.length === 0" class="empty-state">
        <mat-icon class="empty-icon">article</mat-icon>
        <h3>No posts found</h3>
        <p *ngIf="selectedTab === 'my'">
          {{ isMyProfile ? "You haven't published anything yet." : "This user hasn't published anything yet." }}
        </p>

        <p *ngIf="selectedTab === 'saved'">No saved posts yet.</p>
        <p *ngIf="selectedTab === 'liked'">No liked posts yet.</p>
      </div>

      <!-- Posts List - Medium Feed Style -->
      <article *ngFor="let post of posts" class="post-card" (click)="goToPostDetail(post)">
        <!-- Post Header -->
        <div class="post-header">
          <div class="post-meta">
            <span class="post-date">{{ formatDate(post.createdAt) }}</span>
          </div>
        </div>

        <!-- Post Content -->
        <div class="post-body">
          <h2 class="post-title">{{ post.title || 'Untitled' }}</h2>
          <p class="post-excerpt">{{ snippet(post.body) }}</p>

        </div>

        <!-- Cover Media -->
        <div *ngIf="post.coverMedia as media" class="post-media">
          <img *ngIf="media.type === 'image'" [src]="media.url" [alt]="post.title" class="post-image" />
          <video *ngIf="media.type === 'video'" controls class="post-video">
            <source [src]="media.url" />
          </video>
        </div>
      </article>
    </div>
  </div>
</div>

<!-- Followers/Following Modal -->
<div class="modal-overlay" *ngIf="showFollowers || showFollowing" (click)="closeList()">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="modal-head">
      <div class="modal-head-left">
        <h3 class="modal-title">{{ showFollowers ? 'Followers' : 'Following' }}</h3>
        <span class="count-badge">
          {{ (showFollowers ? followers.length : following.length) }} users
        </span>
      </div>

      <button mat-icon-button class="close-btn" type="button" (click)="closeList()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Body -->
    <div class="modal-body">
      <!-- Loading -->
      <div *ngIf="loadingFollowers || loadingFollowing" class="modal-loading">
        <mat-spinner diameter="44" color="primary"></mat-spinner>
        <p>Loading {{ showFollowers ? 'followers' : 'following' }}...</p>
      </div>

      <!-- Empty -->
      <div
        *ngIf="!(loadingFollowers || loadingFollowing) && (showFollowers ? followers.length === 0 : following.length === 0)"
        class="modal-empty">
        <mat-icon class="empty-icon">group_off</mat-icon>
        <h4>{{ showFollowers ? 'No followers yet' : 'Not following anyone yet' }}</h4>
        <p>{{ showFollowers ? 'When people follow you, they’ll appear here.' : 'Users you follow will appear here.' }}
        </p>
      </div>

      <!-- List -->
      <div *ngIf="!(loadingFollowers || loadingFollowing) && (showFollowers ? followers.length : following.length)"
        class="users-list">
        <button type="button" class="user-row" *ngFor="let u of (showFollowers ? followers : following)"
          (click)="goToUserProfile(u.username)">
          <img class="user-avatar" [src]="u.avatarUrl?.trim() ? u.avatarUrl : 'svg/avatar.png'"
            (error)="onImgError($event)" alt="Avatar" />

          <div class="user-info">
            <div class="user-name">{{ u.name || u.username }}</div>
            <div class="user-username">@{{ u.username }}</div>
          </div>

          <mat-icon class="arrow">chevron_right</mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>